<Page x:Class="PDVnet.GestaoProdutos.UI.Pages.DashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:PDVnet.GestaoProdutos.UI.Pages" 
      xmlns:vm="clr-namespace:PDVnet.GestaoProdutos.UI.ViewModels"
      mc:Ignorable="d" 
      TextOptions.TextFormattingMode="Display"
      TextOptions.TextRenderingMode="ClearType"
      UseLayoutRounding="True">

    <Page.DataContext>
        <!-- Para o design-time. Em runtime, é setado no code-behind. -->
        <vm:DashboardViewModel d:IsDataSource="True" />
    </Page.DataContext>

    <!-- O resto do XAML permanece o mesmo -->
    <Grid Margin="14">
        <Grid.RowDefinitions>
            <RowDefinition Height="10"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- titulo -->
        <Grid Grid.Row="1" Grid.ColumnSpan="2" Margin="0,8,0,12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="8"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="Dashboard de Produtos"
                       Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="4" 
                       Style="{StaticResource TitleText}"/>

            <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal">
                <!-- Botao de adicionar -->
                <Button Content="Adicionar Produto" 
                        ToolTip="Adicionar novo produto"
                        Command="{Binding AddNewProdutoCommand}" Margin="0,0,10,0" Padding="8" BorderThickness="0.5"/>

                <!-- Botao de editar -->
                <Button Content="Editar Selecionado"
                        ToolTip="Editar produto selecionado"
                        Command="{Binding EditProdutoCommand}" 
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                        Margin="0,0,10,0" Padding="8" BorderThickness="0.5"/>

                <!-- Botao de excluir -->
                <Button Content="Excluir Selecionado"
                        ToolTip="Excluir produto selecionado"
                        Command="{Binding DeleteProdutoCommand}" 
                        Padding="8" BorderThickness="0.5"/>
            </StackPanel>

            <!-- Botao de atualizar -->
            <Button Grid.Row="2" Grid.Column="3"
                Content="Atualizar Dados"
                Command="{Binding LoadDashboardDataCommand}"
                HorizontalAlignment="Right"
                IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                Style="{StaticResource PrimaryButton}"/>
        </Grid>

        <!-- 1. O número total de produtos cadastrados. -->
        <Border Grid.Row="2" Grid.Column="0" 
                Margin="0,0,20,0"
                Style="{StaticResource CardStyle}">
            <StackPanel>
                <TextBlock Text="Total de Produtos Cadastrados" 
                           Style="{StaticResource CardTitle}"/>
                <TextBlock Text="{Binding TotalProdutosCadastrados}" 
                           Style="{StaticResource CardValue}"/>
            </StackPanel>
        </Border>

        <!-- 3. O valor total do estoque (somatório de `Preço * Quantidade`). -->
        <Border Grid.Row="2" Grid.Column="1" 
                Style="{StaticResource CardStyle}">
            <StackPanel>
                <TextBlock Text="Valor Total do Estoque" 
                           Style="{StaticResource CardTitle}"/>

                <TextBlock Text="{Binding ValorTotalEstoque, StringFormat={}{0:C}, ConverterCulture=pt-BR}" 
                           Style="{StaticResource CardValue}"/>
            </StackPanel>
        </Border>

        <!-- 2. Um alerta para produtos com baixo estoque (quantidade menor que 5). -->
        <Border Grid.Row="3" Grid.ColumnSpan="2" Margin="0,20,0,0"
                Style="{StaticResource CardStyle}" >
            <StackPanel>
                <TextBlock Text="Alerta: Produtos com Baixo Estoque (menor que 5 unidades)" Foreground="OrangeRed" 
                           Style="{StaticResource CardTitle}"/>

                <TextBlock Text="Nenhum produto com baixo estoque!"
                           Visibility="{Binding ProdutosBaixoEstoque.Count, Converter={StaticResource CountToVisibilityConverter}}"
                           Margin="0,10,0,0" FontWeight="SemiBold"/>

                <ListBox ItemsSource="{Binding ProdutosBaixoEstoque}"
                         Visibility="{Binding ProdutosBaixoEstoque.Count, Converter={StaticResource InverseCountToVisibilityConverter}}"
                         Margin="0,10,0,0" MaxHeight="200"
                         BorderThickness="0" Background="Transparent">

                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="0,5">
                                <TextBlock Text="{Binding Nome}" FontWeight="SemiBold"/>
                                <TextBlock Text=" - "/>
                                <TextBlock Text="{Binding Quantidade}"/>
                                <TextBlock Text=" unidades restantes"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

            </StackPanel>
        </Border>

        <!-- DataGrid com todos os produtos -->
        <Border Grid.Row="4" Grid.ColumnSpan="2" Style="{StaticResource CardStyle}" Margin="0,20,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Todos os Produtos" Grid.Row="0" Style="{StaticResource CardTitle}"/>

                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding TodosProdutos}"
                          SelectedItem="{Binding SelectedProduto, Mode=TwoWay}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          AutoGenerateColumns="False" 
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal"
                          RowBackground="LightCyan" 
                          AlternatingRowBackground="WhiteSmoke"
                          Background="Transparent"
                          BorderBrush="#CCCCCC" BorderThickness="1">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" FontSize="14" Width="Auto" TextOptions.TextFormattingMode="Display"/>
                        <DataGridTextColumn Header="Nome" Binding="{Binding Nome}" FontSize="14" Width="*" TextOptions.TextFormattingMode="Display"/>
                        <DataGridTextColumn Header="Descrição" Binding="{Binding Descricao}" FontSize="14" Width="2*" TextOptions.TextFormattingMode="Display"/>
                        <DataGridTextColumn Header="Preço" Binding="{Binding Preco, StringFormat={}{0:C}, ConverterCulture=pt-BR}" FontSize="14" Width="Auto" TextOptions.TextFormattingMode="Display"/>
                        <DataGridTextColumn Header="Quantidade" Binding="{Binding Quantidade}" FontSize="14" Width="Auto" TextOptions.TextFormattingMode="Display"/>
                        <DataGridTextColumn Header="Cadastro" Binding="{Binding DataCadastro, StringFormat='dd/MM/yyyy HH:mm'}" FontSize="14" Width="Auto" TextOptions.TextFormattingMode="Display"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Indicador de carregamento -->
        <ProgressBar Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" 
                     IsIndeterminate="True" Height="10"
                     Opacity="0.9"
                     Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                     HorizontalAlignment="Stretch" VerticalAlignment="Top"/>

    </Grid>

</Page>
